stages:
- build
- docker

build:
  stage: build
  tags:
    - maven
  script:
  - echo "Building..."
  - mvn $MAVEN_REMOTE_OPTS verify -DskipTests
  - echo "Building ended"
  artifacts:
    paths:
    - target/*.jar

docker:
  stage: docker
  image: docker:20.10.23-dind
  tags:
  - docker
  variables:
    DOCKER_HOST: tcp://192.168.252.88:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: docker:20.10.23-dind
      alias: docker
      command: ["--insecure-registry", "192.168.252.88:5000"]

  script:
  - echo "Building start"
  - ls target
  - docker build -t 192.168.252.88:5000/os3/ubik/ubikservice:latest -f ./infra/Dockerfile .
  - docker push 192.168.252.88:5000/os3/ubik/ubikservice:latest
  - echo "Building end"   
